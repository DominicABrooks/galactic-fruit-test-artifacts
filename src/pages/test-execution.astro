---
import MainLayout from "../layouts/MainLayout.astro";
import BuildList from "../components/BuildList.astro";
import builds from "../data/builds.json";
---

<MainLayout title="Test Execution" currentPath="/test-execution">
    <div class="flex flex-col md:flex-row gap-6 h-[calc(100vh-200px)]">
        <!-- Left Panel: Build List -->
        <div
            class="w-full md:w-1/3 bg-eoe-panel border border-white/5 rounded-xl overflow-hidden flex flex-col"
        >
            <div class="p-4 border-b border-white/5 bg-white/[0.02]">
                <div class="relative">
                    <input
                        type="text"
                        placeholder="Search builds..."
                        class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-eoe-accent/50 transition-colors"
                    />
                    <svg
                        class="w-4 h-4 text-eoe-muted absolute right-3 top-2.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path></svg
                    >
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                <BuildList builds={builds} />
            </div>
        </div>

        <!-- Right Panel: Content Area -->
        <div
            class="w-full md:w-2/3 bg-eoe-panel border border-white/5 rounded-xl overflow-hidden flex flex-col relative"
        >
            <!-- Empty State -->
            <div
                id="empty-state"
                class="absolute inset-0 flex flex-col items-center justify-center text-eoe-muted p-8 text-center"
            >
                <div
                    class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-4"
                >
                    <svg
                        class="w-8 h-8 opacity-50"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                        ></path></svg
                    >
                </div>
                <h3 class="text-lg font-medium text-white mb-2">
                    Select a Build
                </h3>
                <p class="text-sm max-w-xs">
                    Choose a test execution from the list to view detailed test
                    cases and results.
                </p>
            </div>

            <!-- Test Cases Table View -->
            <div
                id="test-cases-view"
                class="hidden flex-col h-full animate-fade-in"
            >
                <div
                    class="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]"
                >
                    <div>
                        <h2
                            id="selected-build-name"
                            class="text-xl font-bold text-white"
                        >
                        </h2>
                        <p
                            id="selected-build-meta"
                            class="text-sm text-eoe-muted mt-1"
                        >
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <div
                            class="text-center px-4 py-2 bg-black/20 rounded-lg border border-white/5"
                        >
                            <div
                                class="text-xs text-eoe-muted uppercase tracking-wider"
                            >
                                Total
                            </div>
                            <div
                                id="stat-total"
                                class="text-lg font-bold text-white"
                            >
                                0
                            </div>
                        </div>
                        <div
                            class="text-center px-4 py-2 bg-green-500/10 rounded-lg border border-green-500/20"
                        >
                            <div
                                class="text-xs text-green-400 uppercase tracking-wider"
                            >
                                Pass
                            </div>
                            <div
                                id="stat-pass"
                                class="text-lg font-bold text-green-400"
                            >
                                0
                            </div>
                        </div>
                        <div
                            class="text-center px-4 py-2 bg-red-500/10 rounded-lg border border-red-500/20"
                        >
                            <div
                                class="text-xs text-red-400 uppercase tracking-wider"
                            >
                                Fail
                            </div>
                            <div
                                id="stat-fail"
                                class="text-lg font-bold text-red-400"
                            >
                                0
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-0">
                    <table class="w-full text-left border-collapse">
                        <thead
                            class="bg-black/20 text-xs uppercase text-eoe-muted sticky top-0 backdrop-blur-md"
                        >
                            <tr>
                                <th class="px-6 py-4 font-medium tracking-wider"
                                    >ID</th
                                >
                                <th class="px-6 py-4 font-medium tracking-wider"
                                    >Test Case Name</th
                                >
                                <th class="px-6 py-4 font-medium tracking-wider"
                                    >Status</th
                                >
                                <th class="px-6 py-4 font-medium tracking-wider"
                                    >Notes</th
                                >
                            </tr>
                        </thead>
                        <tbody
                            id="test-cases-body"
                            class="divide-y divide-white/5 text-sm"
                        >
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Test Case Detail View -->
            <div
                id="test-detail-view"
                class="hidden flex-col h-full animate-fade-in bg-eoe-panel absolute inset-0 z-10"
            >
                <div
                    class="p-6 border-b border-white/5 flex items-center gap-4 bg-white/[0.02]"
                >
                    <button
                        id="back-to-table"
                        class="p-2 hover:bg-white/10 rounded-lg transition-colors text-eoe-muted hover:text-white"
                    >
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
                        >
                    </button>
                    <div>
                        <h2
                            id="detail-name"
                            class="text-xl font-bold text-white"
                        >
                        </h2>
                        <div class="flex items-center gap-3 mt-1">
                            <span
                                id="detail-id"
                                class="text-xs font-mono bg-white/10 px-2 py-0.5 rounded text-eoe-muted"
                            ></span>
                            <span
                                id="detail-status"
                                class="text-xs px-2 py-0.5 rounded-full border"
                            ></span>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-8">
                    <div class="max-w-3xl mx-auto">
                        <h3
                            class="text-sm font-semibold text-eoe-muted uppercase tracking-wider mb-4"
                        >
                            Test Steps
                        </h3>
                        <div class="space-y-4">
                            <div
                                id="steps-container"
                                class="relative border-l-2 border-white/10 ml-3 pl-8 space-y-8 py-2"
                            >
                                <!-- Steps injected by JS -->
                            </div>
                        </div>

                        <div
                            class="mt-12 p-6 bg-red-500/5 border border-red-500/10 rounded-xl hidden"
                            id="defect-panel"
                        >
                            <h4
                                class="text-red-400 font-semibold mb-2 flex items-center gap-2"
                            >
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    ><path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                                    ></path></svg
                                >
                                Defect Report
                            </h4>
                            <p id="defect-notes" class="text-sm text-eoe-muted">
                            </p>
                        </div>

                        <!-- Failure Artifacts -->
                        <div
                            id="failure-artifacts"
                            class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 hidden"
                        >
                            <div
                                class="bg-black/20 border border-white/5 rounded-xl p-4"
                            >
                                <h4
                                    class="text-xs text-eoe-muted uppercase tracking-wider mb-3"
                                >
                                    Execution Log
                                </h4>
                                <div
                                    id="execution-log"
                                    class="bg-black/40 rounded p-3 overflow-x-auto"
                                >
                                </div>
                            </div>
                            <div
                                class="bg-black/20 border border-white/5 rounded-xl p-4"
                            >
                                <h4
                                    class="text-xs text-eoe-muted uppercase tracking-wider mb-3"
                                >
                                    Screenshots
                                </h4>
                                <div id="screenshots-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</MainLayout>

<script>
    // Client-side logic
    const base = import.meta.env.BASE_URL || '/';
    const baseSlash = base.endsWith('/') ? base : base + '/';
    document.addEventListener("DOMContentLoaded", async () => {
        const buildItems = document.querySelectorAll(".build-item");
        const emptyState = document.getElementById("empty-state");
        const testCasesView = document.getElementById("test-cases-view");
        const testDetailView = document.getElementById("test-detail-view");
        const testCasesBody = document.getElementById("test-cases-body");
        const backButton = document.getElementById("back-to-table");

        // Load Test Case Index
        let testCaseIndex = {};
        try {
            const response = await fetch(`${baseSlash}data/testCaseIndex.json`);
            testCaseIndex = await response.json();
        } catch (e) {
            console.error("Failed to load test case index", e);
        }

        // State
        let currentBuildId = null;

        // Handle Build Selection
        buildItems.forEach((item) => {
            item.addEventListener("click", () => {
                const buildId = (item as HTMLElement).dataset.id;
                selectBuild(buildId);
            });
        });

        async function selectBuild(buildId) {
            currentBuildId = buildId;

            // Fetch Execution Data
            let executionData: any = null;
            try {
                const response = await fetch(
                    `${baseSlash}data/executions/build_${buildId}.json`,
                );
                executionData = await response.json();
            } catch (e) {
                console.error(
                    `Failed to load execution data for ${buildId}`,
                    e,
                );
                return;
            }

            if (!executionData) return;

            const cases = executionData.results || [];

            // Update UI Active State
            buildItems.forEach((btn) => {
                const indicator = btn.querySelector(".active-indicator");
                if ((btn as HTMLElement).dataset.id === buildId) {
                    btn.classList.add("bg-white/5", "border-white/10");
                    if (indicator) indicator.classList.remove("opacity-0");
                } else {
                    btn.classList.remove("bg-white/5", "border-white/10");
                    if (indicator) indicator.classList.add("opacity-0");
                }
            });

            // Show Table View
            if (emptyState) emptyState.classList.add("hidden");
            if (testDetailView) testDetailView.classList.add("hidden");
            if (testCasesView) testCasesView.classList.remove("hidden");

            // Populate Header (Name/Date come from the list item data attributes or we could fetch builds.json again,
            // but simpler to grab from the clicked element's text for now or pass it in)
            // Actually, we can just use the text content we already have in the DOM or passed via data attributes
            // For now, let's grab it from the clicked element
            const selectedBtn = document.querySelector(
                `.build-item[data-id="${buildId}"]`,
            );
            if (selectedBtn) {
                const buildName =
                    selectedBtn.querySelector(".font-medium")?.textContent ??
                    "";
                const buildDate =
                    selectedBtn.querySelector(
                        ".text-eoe-muted span:first-child",
                    )?.textContent ?? "";

                const selectedBuildName = document.getElementById(
                    "selected-build-name",
                );
                const selectedBuildMeta = document.getElementById(
                    "selected-build-meta",
                );

                if (selectedBuildName && buildName)
                    selectedBuildName.textContent = buildName;
                if (selectedBuildMeta && buildDate)
                    selectedBuildMeta.textContent = buildDate;
            }

            // Stats
            const total = cases.length;
            const passed = cases.filter((c) => c.status === "Pass").length;
            const failed = cases.filter((c) => c.status === "Fail").length;

            const statTotal = document.getElementById("stat-total");
            const statPass = document.getElementById("stat-pass");
            const statFail = document.getElementById("stat-fail");

            if (statTotal) statTotal.textContent = total;
            if (statPass) statPass.textContent = passed;
            if (statFail) statFail.textContent = failed;

            // Populate Table
            if (testCasesBody) {
                testCasesBody.innerHTML = cases
                    .map(
                        (tc) => `
                <tr class="hover:bg-white/5 cursor-pointer transition-colors group" onclick="window.viewTestCase('${tc.testCaseId}', '${tc.status}', '${tc.notes || ""}')">
                    <td class="px-6 py-4 font-mono text-eoe-muted group-hover:text-white">${tc.testCaseId}</td>
                    <td class="px-6 py-4 font-medium text-white">${testCaseIndex[tc.testCaseId] || "Unknown Test Case"}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            tc.status === "Pass"
                                ? "bg-green-500/10 text-green-400 border border-green-500/20"
                                : "bg-red-500/10 text-red-400 border border-red-500/20"
                        }">
                            ${tc.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-eoe-muted truncate max-w-xs">${tc.notes || "-"}</td>
                </tr>
            `,
                    )
                    .join("");
            }

            // Handle Test Case Selection
            (window as any).viewTestCase = async (testId, status, notes) => {
                // Fetch Test Case Definition
                let testCaseDef: any = null;
                try {
                    const response = await fetch(
                        `${baseSlash}data/testCases/${testId}.json`,
                    );
                    testCaseDef = await response.json();
                } catch (e) {
                    console.error(
                        `Failed to load test case definition for ${testId}`,
                        e,
                    );
                    return;
                }

                if (!testCaseDef) return;

                if (testCasesView) testCasesView.classList.add("hidden");
                if (testDetailView) testDetailView.classList.remove("hidden");

                // Populate Detail Header
                const detailName = document.getElementById("detail-name");
                if (detailName) detailName.textContent = testCaseDef.name;

                const detailId = document.getElementById("detail-id");
                if (detailId) detailId.textContent = testCaseDef.id;

                const statusEl = document.getElementById("detail-status");
                if (statusEl) statusEl.textContent = status;
                if (statusEl)
                    statusEl.className = `text-xs px-2 py-0.5 rounded-full border ${
                        status === "Pass"
                            ? "bg-green-500/10 text-green-400 border-green-500/20"
                            : "bg-red-500/10 text-red-400 border-red-500/20"
                    }`;

                // Populate Steps
                const stepsContainer =
                    document.getElementById("steps-container");
                if (stepsContainer) {
                    stepsContainer.innerHTML = testCaseDef.steps
                        .map(
                            (step) => `
                    <div class="relative">
                        <div class="absolute -left-[41px] top-0 w-6 h-6 rounded-full bg-eoe-panel border border-white/20 flex items-center justify-center text-xs text-eoe-muted font-mono">
                            ${step.step}
                        </div>
                        <div class="bg-white/[0.02] border border-white/5 rounded-lg p-4 hover:border-white/10 transition-colors">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Action</div>
                                    <div class="text-sm text-white">${step.action}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Expected Result</div>
                                    <div class="text-sm text-eoe-text">${step.expected}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                        )
                        .join("");
                }

                // Defect Panel & Failure Artifacts
                const defectPanel = document.getElementById("defect-panel");
                const defectNotes = document.getElementById("defect-notes");
                const failureArtifacts =
                    document.getElementById("failure-artifacts");

                if (status === "Fail") {
                    if (defectPanel) defectPanel.classList.remove("hidden");
                    if (failureArtifacts)
                        failureArtifacts.classList.remove("hidden");

                    // Parse Defect ID from notes (e.g. "Defect: ... DEF-001")
                    const defectMatch = notes.match(/(DEF-\d+)/);
                    if (defectNotes) {
                        if (defectMatch) {
                            const defectId = defectMatch[1];
                                defectNotes.innerHTML = `${notes.replace(defectId, "")} <a href="${baseSlash}defects/\${defectId}" class="text-eoe-accent hover:underline font-mono ml-1">\${defectId} â†—</a>`;
                        } else {
                            defectNotes.textContent =
                                notes || "Test failed. No defect ID linked.";
                        }
                    }

                    // Mock Execution Log
                    const executionLog =
                        document.getElementById("execution-log");
                    if (executionLog) {
                        executionLog.innerHTML = `
                    <div class="font-mono text-xs text-eoe-muted space-y-1">
                        <div>[INFO] Starting test execution for ${testId}</div>
                        <div>[INFO] Navigating to /login</div>
                        <div>[INFO] Entering credentials...</div>
                        <div class="text-red-400">[ERROR] Assertion failed: Expected error message not found.</div>
                        <div>[INFO] Taking screenshot...</div>
                    </div>
                `;
                    }

                    // Mock Screenshot
                    const screenshotsContainer = document.getElementById(
                        "screenshots-container",
                    );
                    if (screenshotsContainer) {
                        screenshotsContainer.innerHTML = `
                    <div class="group relative aspect-video bg-black/50 rounded-lg border border-white/10 flex items-center justify-center overflow-hidden">
                        <div class="text-xs text-eoe-muted">Screenshot: error_state.png</div>
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <span class="text-white text-xs">View Full Size</span>
                        </div>
                    </div>
                `;
                    }
                } else {
                    if (defectPanel) defectPanel.classList.add("hidden");
                    if (failureArtifacts)
                        failureArtifacts.classList.add("hidden");
                }
            };

            // Back Button
            if (backButton) {
                backButton.addEventListener("click", () => {
                    if (testDetailView) testDetailView.classList.add("hidden");
                    if (testCasesView) testCasesView.classList.remove("hidden");
                });
            }
        }
    });
</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }
</style>

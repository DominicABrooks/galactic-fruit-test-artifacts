---
import MainLayout from "../layouts/MainLayout.astro";
import BuildList from "../components/BuildList.astro";
import builds from "../data/builds.json";
import fs from 'fs';
import path from 'path';

// Fetch Exploratory Notes
const exploratoryNotes = await Astro.glob('../content/exploratory/*.md');

const BASE = import.meta.env.BASE_URL || "/";
const BASE_SLASH = BASE.endsWith("/") ? BASE : BASE + "/";
const makePath = (p: string) => `${BASE_SLASH}${p.replace(/^\//, "")}`;

const defectsDir = path.resolve('./public/data/defects');
const defectsFiles = fs.readdirSync(defectsDir).filter(f => f.endsWith('.json'));
const defects = defectsFiles.map(file => JSON.parse(fs.readFileSync(path.join(defectsDir, file), 'utf-8')));
---

<MainLayout title="Test Execution" currentPath="/test-execution">
    <div class="flex flex-col h-[calc(100vh-140px)]">
        <!-- Tab Navigation -->
        <div class="flex border-b border-white/10 mb-6">
            <button id="tab-execution" class="px-6 py-3 text-sm font-medium text-white border-b-2 border-eoe-accent transition-colors">
                Test Execution
            </button>
            <button id="tab-exploratory" class="px-6 py-3 text-sm font-medium text-eoe-muted hover:text-white border-b-2 border-transparent transition-colors">
                Exploratory Notes
            </button>
            <button id="tab-defects" class="px-6 py-3 text-sm font-medium text-eoe-muted hover:text-white border-b-2 border-transparent transition-colors">
                Defects
            </button>
        </div>

        <!-- Execution View -->
        <div id="view-execution" class="flex flex-col md:flex-row gap-6 flex-1 min-h-0">
            <!-- Left Panel: Build List -->
            <div class="w-full md:w-1/3 bg-eoe-panel border border-white/5 rounded-xl overflow-hidden flex flex-col">
                <div class="p-4 border-b border-white/5 bg-white/[0.02]">
                    <div class="relative">
                        <input
                            type="text"
                            placeholder="Search builds..."
                            class="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-eoe-accent/50 transition-colors"
                        />
                        <svg
                            class="w-4 h-4 text-eoe-muted absolute right-3 top-2.5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            ></path></svg
                        >
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                    <BuildList builds={builds} />
                </div>
            </div>

            <!-- Right Panel: Content Area -->
            <div class="w-full md:w-2/3 bg-eoe-panel border border-white/5 rounded-xl overflow-hidden flex flex-col relative">
                <!-- Empty State -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-eoe-muted p-8 text-center">
                    <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    </div>
                    <h3 class="text-lg font-medium text-white mb-2">Select a Build</h3>
                    <p class="text-sm max-w-xs">Choose a test execution from the list to view test sets and results.</p>
                </div>

                <!-- Test Sets View -->
                <div id="test-sets-view" class="hidden flex-col h-full animate-fade-in">
                    <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                        <div>
                            <h2 id="sets-build-name" class="text-xl font-bold text-white"></h2>
                            <p id="sets-build-meta" class="text-sm text-eoe-muted mt-1"></p>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-center px-4 py-2 bg-black/20 rounded-lg border border-white/5">
                                <div class="text-xs text-eoe-muted uppercase tracking-wider">Sets</div>
                                <div id="sets-total" class="text-lg font-bold text-white">0</div>
                            </div>
                            <div class="text-center px-4 py-2 bg-green-500/10 rounded-lg border border-green-500/20">
                                <div class="text-xs text-green-400 uppercase tracking-wider">Avg Pass %</div>
                                <div id="sets-avg-pass" class="text-lg font-bold text-green-400">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6">
                        <div id="test-sets-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Test sets injected by JS -->
                        </div>
                    </div>
                </div>

                <!-- Test Cases Table View -->
                <div id="test-cases-view" class="hidden flex-col h-full animate-fade-in">
                    <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                        <div class="flex items-center gap-4">
                            <button id="back-to-sets" class="p-2 hover:bg-white/10 rounded-lg transition-colors text-eoe-muted hover:text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <div>
                                <div class="flex items-center gap-2">
                                    <h2 id="selected-build-name" class="text-xl font-bold text-white"></h2>
                                    <span class="text-eoe-muted">â€¢</span>
                                    <span id="selected-set-name" class="text-lg text-eoe-accent"></span>
                                </div>
                                <p id="selected-build-meta" class="text-sm text-eoe-muted mt-1"></p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-center px-4 py-2 bg-black/20 rounded-lg border border-white/5">
                                <div class="text-xs text-eoe-muted uppercase tracking-wider">Total</div>
                                <div id="stat-total" class="text-lg font-bold text-white">0</div>
                            </div>
                            <div class="text-center px-4 py-2 bg-green-500/10 rounded-lg border border-green-500/20">
                                <div class="text-xs text-green-400 uppercase tracking-wider">Pass</div>
                                <div id="stat-pass" class="text-lg font-bold text-green-400">0</div>
                            </div>
                            <div class="text-center px-4 py-2 bg-red-500/10 rounded-lg border border-red-500/20">
                                <div class="text-xs text-red-400 uppercase tracking-wider">Fail</div>
                                <div id="stat-fail" class="text-lg font-bold text-red-400">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-0">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-black/20 text-xs uppercase text-eoe-muted sticky top-0 backdrop-blur-md">
                                <tr>
                                    <th class="px-6 py-4 font-medium tracking-wider">ID</th>
                                    <th class="px-6 py-4 font-medium tracking-wider">Test Case Name</th>
                                    <th class="px-6 py-4 font-medium tracking-wider">Status</th>
                                    <th class="px-6 py-4 font-medium tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="test-cases-body" class="divide-y divide-white/5 text-sm">
                                <!-- Rows injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Test Case Detail View -->
                <div id="test-detail-view" class="hidden animate-fade-in bg-eoe-panel absolute inset-0 z-10 flex flex-col h-full">
                    <div class="p-6 border-b border-white/5 flex items-center gap-4 bg-white/[0.02]">
                        <button id="back-to-table" class="p-2 hover:bg-white/10 rounded-lg transition-colors text-eoe-muted hover:text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        </button>
                        <div>
                            <h2 id="detail-name" class="text-xl font-bold text-white"></h2>
                            <div class="flex items-center gap-3 mt-1">
                                <span id="detail-id" class="text-xs font-mono bg-white/10 px-2 py-0.5 rounded text-eoe-muted"></span>
                                <span id="detail-status" class="text-xs px-2 py-0.5 rounded-full border"></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                        <div class="max-w-4xl mx-auto space-y-8 pb-8">
                            <!-- Test Case Metadata -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white/[0.02] border border-white/5 rounded-lg p-4 max-h-40 flex flex-col">
                                    <h4 class="text-xs text-eoe-muted uppercase tracking-wider mb-2 flex-shrink-0">Description</h4>
                                    <p id="detail-description" class="text-sm text-white overflow-y-auto custom-scrollbar flex-1"></p>
                                </div>
                                <div class="bg-white/[0.02] border border-white/5 rounded-lg p-4 max-h-40 flex flex-col">
                                    <h4 class="text-xs text-eoe-muted uppercase tracking-wider mb-2 flex-shrink-0">Test Objective</h4>
                                    <p id="detail-objective" class="text-sm text-white overflow-y-auto custom-scrollbar flex-1"></p>
                                </div>
                            </div>

                            <!-- Metadata Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-white/[0.02] border border-white/5 rounded-lg p-3 text-center">
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Priority</div>
                                    <div id="detail-priority" class="text-sm font-medium text-white"></div>
                                </div>
                                <div class="bg-white/[0.02] border border-white/5 rounded-lg p-3 text-center">
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Type</div>
                                    <div id="detail-type" class="text-sm font-medium text-white"></div>
                                </div>
                                <div class="bg-white/[0.02] border border-white/5 rounded-lg p-3 text-center">
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Author</div>
                                    <div id="detail-author" class="text-sm font-medium text-white"></div>
                                </div>
                                <div class="bg-white/[0.02] border border-white/5 rounded-lg p-3 text-center">
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Est. Time</div>
                                    <div id="detail-time" class="text-sm font-medium text-white"></div>
                                </div>
                            </div>

                            <!-- Preconditions -->
                            <div id="preconditions-section" class="bg-blue-500/5 border border-blue-500/10 rounded-xl p-6">
                                <h3 class="text-sm font-semibold text-blue-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Preconditions
                                </h3>
                                <ul id="preconditions-list" class="space-y-2"></ul>
                            </div>

                            <!-- Test Data -->
                            <div id="test-data-section" class="bg-white/[0.02] border border-white/5 rounded-xl p-6">
                                <h3 class="text-sm font-semibold text-eoe-muted uppercase tracking-wider mb-3">Test Data</h3>
                                <div id="test-data-content" class="font-mono text-xs bg-black/40 rounded p-4 overflow-auto custom-scrollbar max-h-60"></div>
                            </div>

                            <!-- Test Steps -->
                            <div>
                                <h3 class="text-sm font-semibold text-eoe-muted uppercase tracking-wider mb-4">Test Steps</h3>
                                <div class="space-y-4">
                                    <div id="steps-container" class="relative border-l-2 border-white/10 ml-3 pl-8 space-y-8 py-2">
                                        <!-- Steps injected by JS -->
                                    </div>
                                </div>
                            </div>

                            <!-- Postconditions -->
                            <div id="postconditions-section" class="bg-green-500/5 border border-green-500/10 rounded-xl p-6">
                                <h3 class="text-sm font-semibold text-green-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    Postconditions
                                </h3>
                                <ul id="postconditions-list" class="space-y-2"></ul>
                            </div>

                            <!-- Tags -->
                            <div id="tags-section">
                                <h3 class="text-sm font-semibold text-eoe-muted uppercase tracking-wider mb-3">Tags</h3>
                                <div id="tags-container" class="flex flex-wrap gap-2"></div>
                            </div>

                            <div class="mt-12 p-6 bg-red-500/5 border border-red-500/10 rounded-xl hidden" id="defect-panel">
                                <h4 class="text-red-400 font-semibold mb-2 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                    Defect Report
                                </h4>
                                <p id="defect-notes" class="text-sm text-eoe-muted"></p>
                            </div>

                            <!-- Failure Artifacts -->
                            <div id="failure-artifacts" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                                <div class="bg-black/20 border border-white/5 rounded-xl p-4">
                                    <h4 class="text-xs text-eoe-muted uppercase tracking-wider mb-3">Execution Log</h4>
                                    <div id="execution-log" class="bg-black/40 rounded p-3 overflow-x-auto"></div>
                                </div>
                                <div class="bg-black/20 border border-white/5 rounded-xl p-4">
                                    <h4 class="text-xs text-eoe-muted uppercase tracking-wider mb-3">Screenshots</h4>
                                    <div id="screenshots-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exploratory View -->
        <div id="view-exploratory" class="hidden flex-1 min-h-0 overflow-y-auto custom-scrollbar">
            <div class="max-w-6xl mx-auto space-y-6 pb-20">
                <div class="bg-eoe-panel border border-white/5 rounded-xl p-8">
                    <h2 class="text-2xl font-bold text-white mb-2">Exploratory Notes</h2>
                    <p class="text-eoe-muted">Reference notes and findings from exploratory testing sessions.</p>
                </div>

                <div class="bg-eoe-panel border border-white/5 rounded-xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white/5 text-xs uppercase text-white sticky top-0">
                            <tr>
                                <th class="px-6 py-4 w-32 whitespace-nowrap">ID</th>
                                <th class="px-6 py-4 w-40 whitespace-nowrap">Category</th>
                                <th class="px-6 py-4 whitespace-nowrap">Title</th>
                                <th class="px-6 py-4 w-64 whitespace-nowrap">Features</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            {exploratoryNotes.map((note) => (
                                <tr class="hover:bg-white/[0.02] transition-colors"
                                onclick={`window.location.href='${BASE_SLASH}exploratory/${note.frontmatter.id}'`}>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <a href={makePath(`exploratory/${note.frontmatter.id}`)} class="text-xs font-mono bg-purple-500/20 text-purple-300 px-2 py-1 rounded hover:bg-purple-500/30 transition-colors">
                                            {note.frontmatter.id}
                                        </a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-xs font-medium text-eoe-muted uppercase tracking-wider">{note.frontmatter.category}</span>
                                    </td>
                                    <td class="px-6 py-4 text-white font-medium whitespace-nowrap">
                                        <a href={makePath(`exploratory/${note.frontmatter.id}`)} class="hover:text-eoe-accent transition-colors block">
                                            {note.frontmatter.title}
                                        </a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex flex-wrap gap-1">
                                            {note.frontmatter.derivedFeatures.map((feature: string) => (
                                                <span class="text-xs bg-white/5 text-white px-2 py-1 rounded border border-white/5">
                                                    {feature}
                                                </span>
                                            ))}
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Defects View -->
        <div id="view-defects" class="hidden flex-1 min-h-0 overflow-y-auto custom-scrollbar">
        <div class="max-w-6xl mx-auto space-y-6 pb-20">
            <!-- Header -->
            <div class="bg-eoe-panel border border-white/5 rounded-xl p-8">
            <h2 class="text-2xl font-bold text-white mb-2">Defects</h2>
            <p class="text-eoe-muted">List of defects found during testing.</p>
            </div>

            <!-- Table -->
            <div class="bg-eoe-panel border border-white/5 rounded-xl overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-white/5 text-xs uppercase text-white sticky top-0">
                <tr>
                    <th class="px-6 py-4 w-32 whitespace-nowrap">ID</th>
                    <th class="px-6 py-4 w-40 whitespace-nowrap">Status</th>
                    <th class="px-6 py-4 w-40 whitespace-nowrap">Severity</th>
                    <th class="px-6 py-4 whitespace-nowrap">Summary</th>
                    <th class="px-6 py-4 w-64 whitespace-nowrap">Environment</th>
                    <th class="px-6 py-4 w-40 whitespace-nowrap">Reporter</th>
                    <th class="px-6 py-4 w-40 whitespace-nowrap">Date</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                {defects.map((defect) => (
                    <tr class="hover:bg-white/[0.02] transition-colors" 
                        onclick={`window.location.href='${BASE_SLASH}defects/${defect.id}'`}
                    >
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href={`/defects/${defect.id}`} class="text-xs font-mono bg-purple-500/20 text-purple-300 px-2 py-1 rounded hover:bg-purple-500/30 transition-colors">
                        {defect.id}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class={`text-xs font-medium px-2 py-1 rounded ${
                        defect.status === "Open"
                            ? "bg-red-500/10 text-red-400 border border-red-500/20"
                            : "bg-green-500/10 text-green-400 border border-green-500/20"
                        }`}>
                        {defect.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">{defect.severity}</td>
                    <td class="px-6 py-4 text-white font-medium">{defect.summary}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{defect.environment}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{defect.reporter}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{defect.date}</td>
                    </tr>
                ))}
                </tbody>
            </table>
            </div>
        </div>
        </div>


    </div>
</MainLayout>

<script>
    // Client-side logic
    const base = import.meta.env.BASE_URL || '/';
    const baseSlash = base.endsWith('/') ? base : base + '/';
    
    document.addEventListener("DOMContentLoaded", async () => {
        const buildItems = document.querySelectorAll(".build-item");
        const emptyState = document.getElementById("empty-state");
        const testSetsView = document.getElementById("test-sets-view");
        const testCasesView = document.getElementById("test-cases-view");
        const testDetailView = document.getElementById("test-detail-view");
        const backToSetsBtn = document.getElementById("back-to-sets");
        const backButton = document.getElementById("back-to-table");

        // Tab Elements
        const tabExecution = document.getElementById("tab-execution");
        const tabExploratory = document.getElementById("tab-exploratory");
        const viewExecution = document.getElementById("view-execution");
        const viewExploratory = document.getElementById("view-exploratory");
        const tabDefects = document.getElementById("tab-defects");
        const viewDefects = document.getElementById("view-defects");

        // Tab Switching Logic
        function switchTab(tab: string) {
            if (tab === 'execution') {
                viewExecution?.classList.remove('hidden');
                viewExecution?.classList.add('flex');
                viewExploratory?.classList.add('hidden');
                
                tabExecution?.classList.add('text-white', 'border-eoe-accent');
                tabExecution?.classList.remove('text-eoe-muted', 'border-transparent');
                
                tabExploratory?.classList.remove('text-white', 'border-eoe-accent');
                tabExploratory?.classList.add('text-eoe-muted', 'border-transparent');

                tabDefects?.classList.remove('text-white', 'border-eoe-accent');
                tabDefects?.classList.add('text-eoe-muted', 'border-transparent');
                
                history.replaceState(null, '', '#execution');
            } else if (tab === 'exploratory') {
                viewExecution?.classList.add('hidden');
                viewExecution?.classList.remove('flex');
                viewExploratory?.classList.remove('hidden');

                viewDefects?.classList.add('hidden');
                viewDefects?.classList.remove('flex');
                
                tabExecution?.classList.remove('text-white', 'border-eoe-accent');
                tabExecution?.classList.add('text-eoe-muted', 'border-transparent');
                
                tabExploratory?.classList.add('text-white', 'border-eoe-accent');
                tabExploratory?.classList.remove('text-eoe-muted', 'border-transparent');

                tabDefects?.classList.remove('text-white', 'border-eoe-accent');
                tabDefects?.classList.add('text-eoe-muted', 'border-transparent');
                
                history.replaceState(null, '', '#exploratory');
            }
            else
            {
                viewExecution?.classList.add('hidden');
                viewExecution?.classList.remove('flex');
                viewExploratory?.classList.add('hidden');
                viewExploratory?.classList.remove('flex');

                viewDefects?.classList.remove('hidden');
                
                tabExecution?.classList.remove('text-white', 'border-eoe-accent');
                tabExecution?.classList.add('text-eoe-muted', 'border-transparent');
                
                tabExploratory?.classList.remove('text-white', 'border-eoe-accent');
                tabExploratory?.classList.add('text-eoe-muted', 'border-transparent');

                tabDefects?.classList.add('text-white', 'border-eoe-accent');
                tabDefects?.classList.remove('text-eoe-muted', 'border-transparent');
                
                history.replaceState(null, '', '#defects');
            }
        }

        tabExecution?.addEventListener('click', () => switchTab('execution'));
        tabExploratory?.addEventListener('click', () => switchTab('exploratory'));
        tabDefects?.addEventListener('click', () => switchTab('defects'));

        // Initial State from URL
        if (window.location.hash === '#exploratory') {
            switchTab('exploratory');
        } else if (window.location.hash === '#defects') {
            switchTab('defects');
        } else {
            switchTab('execution');
        }

        // Show loading state on builds
        buildItems.forEach((item) => {
            // TODO: Maybe make this shimmer or something?
            item.classList.add('opacity-50', 'pointer-events-none');
        });

        // Load Test Sets metadata
        let testSets: any[] = [];
        try {
            const response = await fetch(`${baseSlash}data/testSets.json`);
            const data = await response.json();
            testSets = data.sets || [];
        } catch (e) {
            console.error("Failed to load test sets", e);
        }

        // Load all test cases from all sets
        async function loadAllTestCases() {
            const allTestCases: any = {};
            
            for (const set of testSets) {
                try {
                    // Fetch directory listing - we'll try to fetch known test cases
                    // In a real scenario, you might have an index file per set
                    const testCaseFiles = [];
                    
                    // Try to load test cases with common patterns
                    for (let i = 1; i <= 10; i++) {
                        const paddedNum = String(i).padStart(3, '0');
                        const prefixes = set.id === 'smoke-tests' ? ['SMOKE'] : 
                                       set.id === 'login-tests' ? ['LOGIN'] : 
                                       set.id === 'navigation-tests' ? ['NAV'] : [];
                        
                        for (const prefix of prefixes) {
                            const tcId = `TC-${prefix}-${paddedNum}`;
                            try {
                                const response = await fetch(`${baseSlash}data/testCases/${set.id}/${tcId}.json`);
                                if (response.ok) {
                                    const testCase = await response.json();
                                    if (!allTestCases[set.id]) allTestCases[set.id] = [];
                                    allTestCases[set.id].push(testCase);
                                }
                            } catch (e) {
                                // Test case doesn't exist, skip
                            }
                        }
                    }
                } catch (e) {
                    console.error(`Failed to load test cases for set ${set.id}`, e);
                }
            }
            
            return allTestCases;
        }

        const allTestCases = await loadAllTestCases();

        // Remove loading state from builds - data is ready
        buildItems.forEach((item) => {
            item.classList.remove('opacity-50', 'pointer-events-none');
        });

        // State
        let currentBuildId: string | null = null;
        let currentSetId: string | null = null;
        let executionData: any = null;

        // Handle Build Selection
        buildItems.forEach((item) => {
            item.addEventListener("click", () => {
                const buildId = (item as HTMLElement).dataset.id;
                if (buildId) selectBuild(buildId);
            });
        });

        async function selectBuild(buildId: string) {
            currentBuildId = buildId;

            // Fetch Execution Data
            try {
                const response = await fetch(`${baseSlash}data/executions/build_${buildId}.json`);
                executionData = await response.json();
            } catch (e) {
                console.error(`Failed to load execution data for ${buildId}`, e);
                return;
            }

            if (!executionData) return;

            // Update UI Active State
            buildItems.forEach((btn) => {
                const indicator = btn.querySelector(".active-indicator");
                if ((btn as HTMLElement).dataset.id === buildId) {
                    btn.classList.add("bg-white/5", "border-white/10");
                    if (indicator) indicator.classList.remove("opacity-0");
                } else {
                    btn.classList.remove("bg-white/5", "border-white/10");
                    if (indicator) indicator.classList.add("opacity-0");
                }
            });

            // Show Test Sets View
            if (emptyState) emptyState.classList.add("hidden");
            if (testCasesView) testCasesView.classList.add("hidden");
            if (testDetailView) testDetailView.classList.add("hidden");
            if (testSetsView) testSetsView.classList.remove("hidden");

            // Populate Test Sets
            renderTestSets(buildId);
        }

        function renderTestSets(buildId: string) {
            const selectedBtn = document.querySelector(`.build-item[data-id="${buildId}"]`);
            const buildName = selectedBtn?.querySelector(".font-medium")?.textContent ?? "";
            const buildDate = selectedBtn?.querySelector(".text-eoe-muted span:first-child")?.textContent ?? "";

            const setBuildName = document.getElementById("sets-build-name");
            const setBuildMeta = document.getElementById("sets-build-meta");
            if (setBuildName) setBuildName.textContent = buildName;
            if (setBuildMeta) setBuildMeta.textContent = buildDate;

            const setsContainer = document.getElementById("test-sets-container");
            if (!setsContainer) return;

            // Calculate stats for each set
            const setStats = testSets.map(set => {
                const testCases = allTestCases[set.id] || [];
                const results = executionData?.results || [];
                
                let passed = 0, failed = 0, blocked = 0, skipped = 0;
                
                testCases.forEach((tc: any) => {
                    const result = results.find((r: any) => r.testCaseId === tc.id);
                    if (!result) {
                        passed++; // Default is Pass
                    } else {
                        const status = result.status || 'Fail';
                        if (status === 'Pass') passed++;
                        else if (status === 'Fail') failed++;
                        else if (status === 'Blocked') blocked++;
                        else if (status === 'Skip') skipped++;
                    }
                });

                const total = testCases.length;
                const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;

                return { set, total, passed, failed, blocked, skipped, passRate };
            });

            // Calculate overall stats
            const totalTests = setStats.reduce((sum, s) => sum + s.total, 0);
            const totalPassed = setStats.reduce((sum, s) => sum + s.passed, 0);
            const avgPassRate = totalTests > 0 ? Math.round((totalPassed / totalTests) * 100) : 0;

            const setsTotal = document.getElementById("sets-total");
            const setsAvgPass = document.getElementById("sets-avg-pass");
            if (setsTotal) setsTotal.textContent = testSets.length.toString();
            if (setsAvgPass) setsAvgPass.textContent = `${avgPassRate}%`;

            // Render set cards
            setsContainer.innerHTML = setStats.map(({ set, total, passed, failed, blocked, skipped, passRate }) => `
                <div class="bg-white/[0.02] border border-white/5 rounded-xl p-6 hover:border-white/10 transition-all cursor-pointer group" onclick="selectSet('${set.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-white font-semibold group-hover:text-eoe-accent transition-colors">${set.name}</h3>
                            <p class="text-xs text-eoe-muted mt-1">${set.description}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${passRate === 100 ? 'text-green-400' : passRate >= 80 ? 'text-yellow-400' : 'text-red-400'}">${passRate}%</div>
                            <div class="text-xs text-eoe-muted">Pass Rate</div>
                        </div>
                    </div>
                    <div class="flex gap-4 text-xs">
                        <div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-white/20"></span>
                            <span class="text-eoe-muted">Total:</span>
                            <span class="text-white font-medium">${total}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            <span class="text-green-400">${passed}</span>
                        </div>
                        ${failed > 0 ? `<div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-red-500"></span>
                            <span class="text-red-400">${failed}</span>
                        </div>` : ''}
                        ${blocked > 0 ? `<div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                            <span class="text-orange-400">${blocked}</span>
                        </div>` : ''}
                        ${skipped > 0 ? `<div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-gray-500"></span>
                            <span class="text-gray-400">${skipped}</span>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        (window as any).selectSet = function(setId: string) {
            currentSetId = setId;
            const set = testSets.find(s => s.id === setId);
            if (!set) return;

            const testCases = allTestCases[setId] || [];
            const results = executionData?.results || [];

            // Build full test case list with statuses
            const testCaseList = testCases.map((tc: any) => {
                const result = results.find((r: any) => r.testCaseId === tc.id);
                return {
                    ...tc,
                    status: result ? (result.status || 'Fail') : 'Pass',
                    notes: result?.notes || ''
                };
            });

            // Show Test Cases View
            if (testSetsView) testSetsView.classList.add("hidden");
            if (testCasesView) testCasesView.classList.remove("hidden");
            if (testDetailView) testDetailView.classList.add("hidden");

            // Update header
            const selectedBtn = document.querySelector(`.build-item[data-id="${currentBuildId}"]`);
            const buildName = selectedBtn?.querySelector(".font-medium")?.textContent ?? "";
            const buildDate = selectedBtn?.querySelector(".text-eoe-muted span:first-child")?.textContent ?? "";

            const selectedBuildName = document.getElementById("selected-build-name");
            const selectedSetName = document.getElementById("selected-set-name");
            const selectedBuildMeta = document.getElementById("selected-build-meta");

            if (selectedBuildName) selectedBuildName.textContent = buildName;
            if (selectedSetName) selectedSetName.textContent = set.name;
            if (selectedBuildMeta) selectedBuildMeta.textContent = buildDate;

            // Calculate stats
            const total = testCaseList.length;
            const passed = testCaseList.filter((tc: any) => tc.status === 'Pass').length;
            const failed = testCaseList.filter((tc: any) => tc.status === 'Fail').length;

            const statTotal = document.getElementById("stat-total");
            const statPass = document.getElementById("stat-pass");
            const statFail = document.getElementById("stat-fail");

            if (statTotal) statTotal.textContent = total.toString();
            if (statPass) statPass.textContent = passed.toString();
            if (statFail) statFail.textContent = failed.toString();

            // Populate table
            const testCasesBody = document.getElementById("test-cases-body");
            if (testCasesBody) {
                testCasesBody.innerHTML = testCaseList.map((tc: any) => {
                    const statusColors: Record<string, string> = {
                        'Pass': 'bg-green-500/10 text-green-400 border-green-500/20',
                        'Fail': 'bg-red-500/10 text-red-400 border-red-500/20',
                        'Blocked': 'bg-orange-500/10 text-orange-400 border-orange-500/20',
                        'Skip': 'bg-gray-500/10 text-gray-400 border-gray-500/20'
                    };

                    return `
                        <tr class="hover:bg-white/5 cursor-pointer transition-colors group" onclick="window.viewTestCase('${tc.id}', '${tc.status}', '${tc.notes}', '${setId}')">
                            <td class="px-6 py-4 font-mono text-eoe-muted group-hover:text-white">${tc.id}</td>
                            <td class="px-6 py-4 font-medium text-white">${tc.name}</td>
                            <td class="px-6 py-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusColors[tc.status] || statusColors['Fail']}">
                                    ${tc.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-eoe-muted truncate max-w-xs">${tc.notes || '-'}</td>
                        </tr>
                    `;
                }).join('');
            }
        };

        (window as any).viewTestCase = async function(testId: string, status: string, notes: string, setId: string) {
            // Fetch test case from correct set directory
            let testCaseDef: any = null;
            try {
                const response = await fetch(`${baseSlash}data/testCases/${setId}/${testId}.json`);
                testCaseDef = await response.json();
            } catch (e) {
                console.error(`Failed to load test case ${testId}`, e);
                return;
            }

            if (!testCaseDef) return;

            if (testCasesView) testCasesView.classList.add("hidden");
            if (testDetailView) testDetailView.classList.remove("hidden");

            // Populate header
            const detailName = document.getElementById("detail-name");
            const detailId = document.getElementById("detail-id");
            const statusEl = document.getElementById("detail-status");

            if (detailName) detailName.textContent = testCaseDef.name;
            if (detailId) detailId.textContent = testCaseDef.id;

            const statusColors: Record<string, string> = {
                'Pass': 'bg-green-500/10 text-green-400 border-green-500/20',
                'Fail': 'bg-red-500/10 text-red-400 border-red-500/20',
                'Blocked': 'bg-orange-500/10 text-orange-400 border-orange-500/20',
                'Skip': 'bg-gray-500/10 text-gray-400 border-gray-500/20'
            };

            if (statusEl) {
                statusEl.textContent = status;
                statusEl.className = `text-xs px-2 py-0.5 rounded-full border ${statusColors[status] || statusColors['Fail']}`;
            }

            // Populate metadata
            const description = document.getElementById("detail-description");
            const objective = document.getElementById("detail-objective");
            const priority = document.getElementById("detail-priority");
            const type = document.getElementById("detail-type");
            const author = document.getElementById("detail-author");
            const time = document.getElementById("detail-time");

            if (description) description.textContent = testCaseDef.description || '-';
            if (objective) objective.textContent = testCaseDef.testObjective || '-';
            if (priority) priority.textContent = testCaseDef.priority || '-';
            if (type) type.textContent = testCaseDef.type || '-';
            if (author) author.textContent = testCaseDef.author || '-';
            if (time) time.textContent = testCaseDef.estimatedExecutionTime || '-';

            // Populate preconditions
            const preconditionsSection = document.getElementById("preconditions-section");
            const preconditionsList = document.getElementById("preconditions-list");
            if (testCaseDef.preconditions && testCaseDef.preconditions.length > 0) {
                if (preconditionsSection) preconditionsSection.classList.remove("hidden");
                if (preconditionsList) {
                    preconditionsList.innerHTML = testCaseDef.preconditions.map((pc: string) => `
                        <li class="flex items-start gap-2 text-sm text-white">
                            <svg class="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                            <span>${pc}</span>
                        </li>
                    `).join('');
                }
            } else {
                if (preconditionsSection) preconditionsSection.classList.add("hidden");
            }

            // Populate test data
            const testDataSection = document.getElementById("test-data-section");
            const testDataContent = document.getElementById("test-data-content");
            if (testCaseDef.testData) {
                if (testDataSection) testDataSection.classList.remove("hidden");
                if (testDataContent) {
                    testDataContent.textContent = JSON.stringify(testCaseDef.testData, null, 2);
                }
            } else {
                if (testDataSection) testDataSection.classList.add("hidden");
            }

            // Populate steps
            const stepsContainer = document.getElementById("steps-container");
            if (stepsContainer) {
                stepsContainer.innerHTML = testCaseDef.steps.map((step: any) => `
                    <div class="relative">
                        <div class="absolute -left-[41px] top-0 w-6 h-6 rounded-full bg-eoe-panel border border-white/20 flex items-center justify-center text-xs text-eoe-muted font-mono">
                            ${step.step}
                        </div>
                        <div class="bg-white/[0.02] border border-white/5 rounded-lg p-4 hover:border-white/10 transition-colors">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Action</div>
                                    <div class="text-sm text-white">${step.action}</div>
                                    ${step.testData ? `<div class="mt-2 text-xs text-blue-300 font-mono">Data: ${step.testData}</div>` : ''}
                                </div>
                                <div>
                                    <div class="text-xs text-eoe-muted uppercase tracking-wider mb-1">Expected Result</div>
                                    <div class="text-sm text-eoe-text">${step.expected}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Populate postconditions
            const postconditionsSection = document.getElementById("postconditions-section");
            const postconditionsList = document.getElementById("postconditions-list");
            if (testCaseDef.postconditions && testCaseDef.postconditions.length > 0) {
                if (postconditionsSection) postconditionsSection.classList.remove("hidden");
                if (postconditionsList) {
                    postconditionsList.innerHTML = testCaseDef.postconditions.map((pc: string) => `
                        <li class="flex items-start gap-2 text-sm text-white">
                            <svg class="w-4 h-4 text-green-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>${pc}</span>
                        </li>
                    `).join('');
                }
            } else {
                if (postconditionsSection) postconditionsSection.classList.add("hidden");
            }

            // Populate tags
            const tagsSection = document.getElementById("tags-section");
            const tagsContainer = document.getElementById("tags-container");
            if (testCaseDef.tags && testCaseDef.tags.length > 0) {
                if (tagsSection) tagsSection.classList.remove("hidden");
                if (tagsContainer) {
                    tagsContainer.innerHTML = testCaseDef.tags.map((tag: string) => `
                        <span class="text-xs bg-purple-500/10 text-purple-300 px-3 py-1 rounded-full border border-purple-500/20">
                            #${tag}
                        </span>
                    `).join('');
                }
            } else {
                if (tagsSection) tagsSection.classList.add("hidden");
            }

            // Handle defect panel
            const defectPanel = document.getElementById("defect-panel");
            const defectNotes = document.getElementById("defect-notes");
            const failureArtifacts = document.getElementById("failure-artifacts");

            if (status === 'Fail') {
                if (defectPanel) defectPanel.classList.remove("hidden");
                if (failureArtifacts) failureArtifacts.classList.remove("hidden");

                const defectMatch = notes.match(/(DEF-\d+)/);
                if (defectNotes) {
                    if (defectMatch) {
                        const defectId = defectMatch[1];
                        defectNotes.innerHTML = `${notes.replace(defectId, "")} <a href="${baseSlash}defects/${defectId}" class="text-eoe-accent hover:underline font-mono ml-1">${defectId} â†—</a>`;
                    } else {
                        defectNotes.textContent = notes || "Test failed. No defect ID linked.";
                    }
                }
            } else {
                if (defectPanel) defectPanel.classList.add("hidden");
                if (failureArtifacts) failureArtifacts.classList.add("hidden");
            }
        };

        // Back buttons
        if (backToSetsBtn) {
            backToSetsBtn.addEventListener("click", () => {
                if (testCasesView) testCasesView.classList.add("hidden");
                if (testSetsView) testSetsView.classList.remove("hidden");
            });
        }

        if (backButton) {
            backButton.addEventListener("click", () => {
                if (testDetailView) testDetailView.classList.add("hidden");
                if (testCasesView) testCasesView.classList.remove("hidden");
            });
        }
    });
</script>

<style>

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Shimmer loading animation */
    @keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }
        100% {
            background-position: 1000px 0;
        }
    }

    .shimmer-loading {
        animation: shimmer 2s infinite linear;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.02) 0%,
            rgba(255, 255, 255, 0.08) 50%,
            rgba(255, 255, 255, 0.02) 100%
        );
        background-size: 1000px 100%;
        pointer-events: none;
        position: relative;
    }

    .shimmer-loading::after {
        content: "Loading...";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
</style>

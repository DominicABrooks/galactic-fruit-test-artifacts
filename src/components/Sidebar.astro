---
const navStructure = [
    {
        name: "Home",
        path: "/",
        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>`,
    },
    {
        name: "Testing",
        children: [
            { name: "Planning", path: "/test-planning" },
            { name: "Analysis", path: "/test-analysis" },
            { name: "Design", path: "/test-design" },
            { name: "Implementation", path: "/test-implementation" },
            { name: "Execution", path: "/test-execution" },
            { name: "Closure", path: "/test-closure" },
        ],
        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>`,
    },
    {
        name: "About Us",
        path: "/about",
        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
    },
];

const { currentPath } = Astro.props;
const BASE = import.meta.env.BASE_URL || "/";
const BASE_SLASH = BASE.endsWith("/") ? BASE : BASE + "/";
const makePath = (p: string) => `${BASE_SLASH}${p.replace(/^\//, "")}`;

const rawCurrent = Astro.props?.currentPath || "";
const normalize = (p: string) => {
    if (!p) return "";
    let s = p;
    const baseNoSlash = BASE.replace(/\/$/, "");
    if (
        baseNoSlash !== "/" &&
        baseNoSlash !== "" &&
        s.startsWith(baseNoSlash)
    ) {
        s = s.slice(baseNoSlash.length);
    } else if (BASE !== "/" && s.startsWith(BASE)) {
        s = s.slice(BASE.length);
    }
    if (!s.startsWith("/")) s = "/" + s;
    if (s !== "/") s = s.replace(/\/$/, "");
    return s;
};
const normalizedCurrent = normalize(rawCurrent as string);

// Check if any child of "Testing" is active to auto-expand
const isTestingActive = navStructure
    .find((item) => item.name === "Testing")
    ?.children?.some((child) => normalizedCurrent === child.path);
---

<aside
    class="w-64 h-screen bg-eoe-panel border-r border-white/5 fixed left-0 top-0 overflow-y-auto z-50 hidden md:block flex flex-col"
>
    <div class="p-6">
        <h1 class="text-xl font-bold tracking-tight text-white mb-2">
            Galactic Fruit
        </h1>
        <p class="text-xs text-eoe-muted uppercase tracking-wider mb-8">
            Test Artifacts
        </p>

        <nav class="space-y-1">
            {
                navStructure.map((item) => {
                    if (item.children) {
                        return (
                            <details class="group" open={isTestingActive}>
                                <summary class="flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium text-eoe-muted hover:text-white hover:bg-white/5 cursor-pointer transition-colors select-none">
                                    <span class="flex items-center gap-3">
                                        <span set:html={item.icon} />
                                        {item.name}
                                    </span>
                                    <svg
                                        class="w-4 h-4 transition-transform group-open:rotate-180"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 9l-7 7-7-7"
                                        />
                                    </svg>
                                </summary>
                                <div class="pl-11 pr-2 py-2 space-y-1">
                                    {item.children.map((child) => (
                                        <a
                                            href={makePath(child.path)}
                                            class:list={[
                                                "block px-3 py-2 rounded-md text-sm transition-all duration-200 whitespace-nowrap truncate",
                                                normalizedCurrent === child.path
                                                    ? "text-white bg-white/10 font-medium"
                                                    : "text-eoe-muted hover:text-white hover:bg-white/5",
                                            ]}
                                        >
                                            {child.name}
                                        </a>
                                    ))}
                                </div>
                            </details>
                        );
                    } else {
                        return (
                            <a
                                href={makePath(item.path)}
                                class:list={[
                                    "flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200",
                                    normalizedCurrent === item.path
                                        ? "bg-eoe-accent/10 text-eoe-accent border border-eoe-accent/20 shadow-[0_0_15px_rgba(59,130,246,0.1)]"
                                        : "text-eoe-muted hover:text-white hover:bg-white/5",
                                ]}
                            >
                                <span set:html={item.icon} />
                                {item.name}
                            </a>
                        );
                    }
                })
            }
        </nav>
    </div>
    <!-- 
    <div class="mt-auto p-6 border-t border-white/5">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 rounded-full bg-gradient-to-br from-eoe-accent to-purple-600 flex items-center justify-center text-xs font-bold text-white"
            >
                QA
            </div>
            <div>
                <p class="text-sm font-medium text-white">QA Team</p>
                <p class="text-xs text-eoe-muted">v1.0.0</p>
            </div>
        </div>
    </div> -->
</aside>
